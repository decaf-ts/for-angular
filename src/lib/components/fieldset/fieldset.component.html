

  <fieldset
    (fieldsetAddGroupEvent)="handleCreateItem($event)"
    [class]="'dcf-fieldset-component ' + operation"
    [class.dcf-blank]="!borders"
    [class.open]="isOpen"
    [class.dcf-not-collapsable]="!collapsable"
    #component>
    <div class="dcf-width-1-1">
      @if (!collapsable || required) {
        <legend class="dcf-title">{{ (title ? title : name) | translate }}</legend>
      }
      <ion-accordion-group class="dcf-width-1-1" [class.open]="isOpen" [class.hasValidationErrors]="hasValidationErrors" [value]="(operation === 'read' || !collapsable) ? 'open' : ''" #accordionComponent>
        <ion-accordion
          value="open"
          [class.dcf-disabled]="!activePage"
          [class.dcf-empty]="!items?.length"
        >
          @if (collapsable && !required) {
            <ion-item slot="header" [button]="collapsable" (click)="handleAccordionToggle($event)">
              <div class="dcf-grid dcf-grid-collapse dcf-flex dcf-flex-middle dcf-width-1-1">
                <div class="dcf-width-expand">
                  <legend>{{ (title ? title : name) | translate }}</legend>
                </div>
                @if (!isRequired && ['create', 'update'].includes(operation) && collapsable && multiple) {
                  <div class="dcf-width-auto dcf-delete">
                    <ion-button fill="clear" size="small" (click)="handleClear($event)">
                      <ion-icon aria-hidden="true" name="trash-outline" color="dark" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                }
              </div>
            </ion-item>
          }

          <div slot="content" [attr.aria-hidden]="!isOpen">
           @if (['create', 'update'].includes(operation) || !multiple) {
              @if(activePage) {
                <div>
                  <ngx-decaf-layout
                    [className]="'dcf-fieldset-grid dcf-grid-nested'"
                    [flexMode]="props.flexMode ?? false"
                    [match]="false"
                    [gap]="'small'"
                    [children]="activePage || []"
                    [parentForm]="formGroup || parentForm"
                    [rows]="rows"
                    [cols]="cols"
                    [borders]="activePage?.borders  ?? false"
                    [breakpoint]="breakpoint ?? 'large'"
                    [hidden]="items.length === max && !updatingItem"
                  />
                </div>
              }
            } @else {
              @if(refreshing) {
                <div class="dcf-loading-container">
                  <ion-spinner name="crescent" color="primary"></ion-spinner>
                </div>
              } @else {
                @if(!items.length) {
                  <div class="dcf-padding-xsmall">
                    <ion-text class="dcf-text-small">{{ locale + '.empty' | translate }}</ion-text>
                  </div>
                } @else {
                  @for(item of items; track trackItemFn($index, item)) {
                    <div class="dcf-fieldset-item">
                      <div>
                        <ngx-decaf-layout
                          [className]="'dcf-fieldset-grid dcf-grid-nested ' + operation"
                          [flexMode]="item?.props?.flexMode ?? false"
                          [match]="false"
                          [gap]="'collapse'"
                          [children]="item || []"
                          [rows]="rows"
                          [cols]="cols"
                          [borders]="item?.props?.borders  ?? false"
                          [breakpoint]="breakpoint ?? 'large'"
                        />
                      </div>
                    </div>
                  }
                }
              }
            }
          </div>
        </ion-accordion>
      </ion-accordion-group>
      @if (multiple && ['create', 'update'].includes(operation)) {
        @if (multiple && items.length) {
          <ion-list class="dcf-fields-list">
            <ion-reorder-group [formGroup]="formGroup.parent" [disabled]="updatingItem" (ionItemReorder)="handleReorderItems($any($event))" #accordionComponent>
              @for(item of items; track item.index) {
                <ion-item [class.not-unique]="item.title === isUniqueError"  [class.updating]="updatingItem?.[pk] === item.title" lines="full" [button]="false">
                  @if(ordenable) {
                    @if (items?.length > 1 && !updatingItem) {
                      <ion-reorder slot="start">
                        <ion-icon aria-hidden="true" name="swap-vertical-outline"></ion-icon>
                      </ion-reorder>
                    } @else {
                      <div slot="start">
                        <ion-icon aria-hidden="true" class="dcf-reorder-disabled" size="small" name="swap-vertical-outline" disabled></ion-icon>
                      </div>
                    }
                  }

                  <ion-label [color]="(item.title === isUniqueError && !updatingItem?.[pk] === item.title) ? 'danger' : ''">{{ item.index }}. {{ item.title }}
                    @if (item.description?.length > 0) {
                      <br />
                      <ion-text class="dcf-subtitle">{{item.description}}</ion-text>
                    }
                  </ion-label>

                  @if(editable) {
                    @if (!updatingItem || updatingItem?.[pk] !== item.title) {
                      <ion-button fill="clear" size="small" (click)="handleUpdateItem($index)">
                        <ion-icon aria-hidden="true" name="create-outline" color="dark" ></ion-icon>
                      </ion-button>
                    }
                  }


                  @if (!updatingItem) {
                    <ion-button fill="clear" size="small" color="danger" (click)="handleRemoveItem($index)">
                      <ion-icon aria-hidden="true" name="close-outline" color="dark"></ion-icon>
                    </ion-button>
                  }
                </ion-item>
              }
            </ion-reorder-group>
          </ion-list>
        }

        @if (isUniqueError) {
          <div class="dcf-not-unique-container dcf-animation dcf-animation-bottom-small dcf-animation-fast">
            <div class=" dcf-grid dcf-grid-collapse dcf-width-1-1 ">
              <div class="dcf-auto" [attr.style]="'max-width: 50px'">
                <ion-icon aria-hidden="true" name="alert-circle-outline"></ion-icon>
              </div>
              <div class="dcf-width-expand">
                <ion-text color="danger" class="dcf-text-small">{{ locale + '.not_unique' | translate : { value: isUniqueError } }}</ion-text>
              </div>
            </div>
          </div>
        }

        @if(max) {
          <div class="dcf-width-1-1 dcf-max-message-container">
            <ion-text class="dcf-text-small"
              [color]="items.length !== max ? (!isDarkMode ? 'medium' : '') : 'primary'"
            >
              {{ locale + (items.length !== max ?  '.max_items' : '.max_items_reached') | translate : { '0': max } }}
            </ion-text>
          </div>
        }

        <div class="dcf-grid dcf-grid-small dcf-flex dcf-buttons-container" [class.dcf-not-collapsable]="!collapsable"  [class.dcf-empty]="!activePage" [class.dcf-blank]="!borders">
          @if (updatingItem) {
            <div>
              <ion-button size="small" fill="clear" color="danger" (click)="handleCancelUpdateItem()">
                {{ locale + '.cancel' | translate }}
              </ion-button>
            </div>
            <div>
              <ion-button size="small" fill="clear" (click)="handleCreateItem()">
                <ion-icon  aria-hidden="true" name="refresh-outline" slot="start"></ion-icon>
                {{ locale + '.update' | translate }}
              </ion-button>
            </div>
          } @else {
            @if (items.length < max || !max) {
              <div>
                <ion-button size="small" fill="clear" class="dcf-button-add" [color]="isDarkMode ? 'light' : 'dark'" (click)="handleCreateItem()">
                  <ion-icon aria-hidden="true" name="add-outline" slot="start"></ion-icon>
                  {{ locale + '.add' | translate }}
                </ion-button>
              </div>
            }
          }
        </div>
      }
    </div>
  </fieldset>


